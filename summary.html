<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Báo cáo chi tiết bài tập</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        padding: 20px;
        background-color: #f0f2f5;
        color: #333;
        margin: 0;
      }

      .summary-container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        background: linear-gradient(135deg, #1a73e8, #34a853);
        color: white;
        padding: 30px;
        border-radius: 8px;
        position: relative;
      }

      .header h1 {
        margin: 0;
        font-size: 28px;
      }

      .user-info {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 14px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        text-align: center;
        transition: transform 0.3s ease;
        border: 1px solid #e0e0e0;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #1a73e8;
        margin: 10px 0;
      }

      .stat-label {
        color: #666;
        font-size: 14px;
      }

      .exercise-details {
        margin-top: 40px;
      }

      .detail-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #1a73e8;
      }

      .recommendations {
        background: #e8f5e9;
        padding: 20px;
        border-radius: 8px;
        margin-top: 30px;
      }

      .recommendation-item {
        background: white;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .recommendation-icon {
        margin-right: 15px;
        color: #34a853;
        font-size: 24px;
      }

      .progress-section {
        margin: 30px 0;
      }

      .progress-bar {
        height: 20px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #1a73e8, #34a853);
        transition: width 1s ease;
        border-radius: 10px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        background: white;
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      th {
        background: #1a73e8;
        color: white;
      }

      tr:hover {
        background: #f5f5f5;
      }

      .accuracy-high {
        color: #34a853;
      }

      .accuracy-medium {
        color: #fbbc05;
      }

      .accuracy-low {
        color: #ea4335;
      }

      .button-container {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        justify-content: center;
      }

      .button {
        padding: 12px 25px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .primary-btn {
        background: #1a73e8;
        color: white;
      }

      .secondary-btn {
        background: #f8f9fa;
        color: #1a73e8;
        border: 1px solid #1a73e8;
      }

      .reset-btn {
        background: #dc3545;
        color: white;
      }

      .button:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-out;
      }

      @media (max-width: 768px) {
        .stats-grid {
          grid-template-columns: 1fr 1fr;
        }

        .button-container {
          flex-direction: column;
        }

        .header {
          padding: 20px;
        }

        .user-info {
          position: static;
          margin-top: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="summary-container fade-in">
      <div class="header">
        <div class="user-info">
          Học viên: <strong>hieuuuues</strong><br />
          <span id="currentTime"></span>
        </div>
        <h1>Báo cáo chi tiết bài tập</h1>
        <p>Phân tích và đánh giá kết quả học tập của bạn</p>
      </div>

      <div id="overallStats" class="stats-grid">
        <!-- Filled by JavaScript -->
      </div>

      <div class="progress-section">
        <h3>Tiến độ hoàn thành</h3>
        <div class="progress-bar">
          <div id="progressBar" class="progress-fill"></div>
        </div>
      </div>

      <div class="exercise-details">
        <h3>Chi tiết từng bài tập</h3>
        <div id="exerciseTable">
          <!-- Filled by JavaScript -->
        </div>
      </div>

      <div class="recommendations">
        <h3>Phân tích và Gợi ý</h3>
        <div id="recommendationsList">
          <!-- Filled by JavaScript -->
        </div>
      </div>

      <div class="button-container">
        <button
          onclick="window.location.href='index.html'"
          class="button primary-btn"
        >
          Quay lại trang chính
        </button>
        <button onclick="printSummary()" class="button secondary-btn">
          In báo cáo
        </button>
        <button onclick="resetData()" class="button reset-btn">
          Xóa dữ liệu
        </button>
      </div>
    </div>

    <script src="tracking.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        updateSummary();
        setInterval(updateSummary, 60000); // Cập nhật mỗi phút

        // Cập nhật thời gian
        function updateTime() {
          const now = new Date();
          document.getElementById("currentTime").textContent =
            now.toLocaleString("vi-VN");
        }
        updateTime();
        setInterval(updateTime, 1000);
      });

      function updateSummary() {
        const summary = window.exerciseTracker.getSummary();
        updateOverallStats(summary);
        updateProgressBar(summary);
        updateExerciseTable(summary);
        updateRecommendations(summary);
      }

      function updateOverallStats(summary) {
        const totalAttempted = summary.totalCorrect + summary.totalWrong;
        const accuracy =
          totalAttempted > 0
            ? ((summary.totalCorrect / totalAttempted) * 100).toFixed(1)
            : 0;

        const statsHTML = `
                <div class="stat-card">
                    <div class="stat-value">${summary.completedExercises}/${summary.totalExercises}</div>
                    <div class="stat-label">Bài tập đã hoàn thành</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${summary.totalCorrect}</div>
                    <div class="stat-label">Tổng số câu đúng</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${summary.totalWrong}</div>
                    <div class="stat-label">Tổng số câu sai</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${accuracy}%</div>
                    <div class="stat-label">Tỷ lệ chính xác</div>
                </div>
            `;
        document.getElementById("overallStats").innerHTML = statsHTML;
      }

      function updateProgressBar(summary) {
        const progress =
          (summary.completedExercises / summary.totalExercises) * 100;
        document.getElementById("progressBar").style.width = `${progress}%`;
      }

      function updateExerciseTable(summary) {
        if (!summary.exercises.length) {
          document.getElementById("exerciseTable").innerHTML =
            '<p class="no-data">Chưa có bài tập nào được hoàn thành</p>';
          return;
        }

        const tableHTML = `
                <table>
                    <tr>
                        <th>Bài tập</th>
                        <th>Trạng thái</th>
                        <th>Thời gian</th>
                        <th>Số câu đúng</th>
                        <th>Số câu sai</th>
                        <th>Tỷ lệ đúng</th>
                        <th>Tiến bộ</th>
                    </tr>
                    ${summary.exercises
                      .map(
                        (ex) => `
                        <tr>
                            <td>Bài ${ex.id}</td>
                            <td>${
                              ex.completed ? "Đã hoàn thành" : "Chưa hoàn thành"
                            }</td>
                            <td>${formatTime(ex.duration)}</td>
                            <td>${ex.correct || 0}</td>
                            <td>${ex.wrong || 0}</td>
                            <td class="${getAccuracyClass(ex.percentage)}">
                                ${ex.percentage}%
                            </td>
                            <td>${formatImprovement(ex.improvement)}</td>
                        </tr>
                    `
                      )
                      .join("")}
            </table>
            `;
        document.getElementById("exerciseTable").innerHTML = tableHTML;
      }

      function updateRecommendations(summary) {
        if (!summary.recommendations || !summary.recommendations.length) {
          return;
        }

        const recommendationsHTML = `
                <div class="recommendations-list">
                    ${summary.recommendations
                      .map(
                        (rec) => `
                        <div class="recommendation-item">
                            <span class="recommendation-icon">💡</span>
                            <div class="recommendation-text">${rec}</div>
                        </div>
                    `
                      )
                      .join("")}
                    <div class="update-time">
                        Cập nhật lúc: ${new Date().toLocaleTimeString("vi-VN")}
                    </div>
                </div>
            `;
        document.getElementById("recommendationsList").innerHTML =
          recommendationsHTML;
      }

      function formatTime(minutes) {
        if (typeof minutes !== "number" || minutes === 0) return "0 phút";
        if (minutes < 60) return `${minutes} phút`;
        const hours = Math.floor(minutes / 60);
        const remainingMinutes = minutes % 60;
        return `${hours} giờ ${remainingMinutes} phút`;
      }

      function getAccuracyClass(percentage) {
        if (percentage >= 80) return "accuracy-high";
        if (percentage >= 50) return "accuracy-medium";
        return "accuracy-low";
      }

      function formatImprovement(improvement) {
        if (!improvement) return "—";

        let result = [];
        if (improvement.accuracy) {
          const sign = improvement.accuracy > 0 ? "+" : "";
          result.push(
            `${sign}${improvement.accuracy.toFixed(1)}% độ chính xác`
          );
        }
        if (improvement.time) {
          const sign = improvement.time > 0 ? "+" : "";
          result.push(`${sign}${improvement.time} phút`);
        }

        return result.length ? result.join(", ") : "—";
      }

      function resetData() {
        if (
          confirm(
            "Bạn có chắc chắn muốn xóa tất cả dữ liệu không? Hành động này không thể hoàn tác."
          )
        ) {
          window.exerciseTracker.clearData();
          window.location.reload();
        }
      }

      function printSummary() {
        window.print();
      }

      // Kiểm tra quyền truy cập
      function checkAccess() {
        const data = JSON.parse(localStorage.getItem("exerciseData")) || {};
        const completedCount = Object.values(data.exercises || {}).filter(
          (ex) => ex.completed
        ).length;

        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const timeAccess = hours === 19 && minutes >= 48;

        if (!timeAccess && completedCount < 4) {
          window.location.href = "index.html";
          return false;
        }
        return true;
      }

      // Thêm style cho in ấn
      const printStyles = `
            @media print {
                body {
                    padding: 0;
                    background: white;
                }
                .button-container {
                    display: none;
                }
                .summary-container {
                    box-shadow: none;
                }
                .recommendation-item {
                    break-inside: avoid;
                }
                .header {
                    background: #f0f2f5;
                    color: black;
                }
                @page {
                    margin: 2cm;
                }
            }
        `;

      const styleSheet = document.createElement("style");
      styleSheet.innerText = printStyles;
      document.head.appendChild(styleSheet);

      // Kiểm tra quyền truy cập khi tải trang
      if (!checkAccess()) {
        // Nếu không có quyền truy cập, trang sẽ tự chuyển về index.html
        console.log("Không có quyền truy cập summary");
      }
    </script>
  </body>
</html>
